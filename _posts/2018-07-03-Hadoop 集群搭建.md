---
title: Hadoop 集群搭建
layout: post
tags: Hadoop
categories: Hadoop
---
##### 搭建过那么多次hadoop也没好好总结下，这次公司发了电脑，跑3台虚拟机完全不虚，所以想在自己的机器上搭建hadoop,学习大数据做相关实验，为了避免以后再重复学习，找资料花费大量时间，做笔记如下
#####一切内容均摘自cloudera官网
## 0、参考资料
官方参考文档：[http://www.cloudera.com/]()  

官方安装文档：[https://www.cloudera.com/documentation/enterprise/latest/topics/install_cm_cdh.html]()

官方__版本和下载信息__： [https://www.cloudera.com/documentation/enterprise/release-notes/topics/rg_vd.html]()
## 1、离线下载资料： 

CM:cloudera-manager-daemons-5.15.0-1.cm5150.p0.62.el7.x86_64.rpm  

下载地址  [https://archive.cloudera.com/cm5/redhat/7/x86_64/cm/5.15.0/RPMS/x86_64/4/]()

CDH: 

- CDH-5.15.0-1.cdh5.15.0.p0.21-el7.parcel  

- CDH-5.15.0-1.cdh5.15.0.p0.21-el7.parcel.sha1

- 下载地址 [http://archive.cloudera.com/cdh5/parcels/5.15.0/]()

## 2、安装之前的准备： 
配置网络名称  
1. 将主机设置为唯一名称  
        sudo hostnamectl set-hostname ccc.example.com  
2. 编辑 `/etc/hosts`文件使用群集中每个主机的IP地址和完全限定的域名（FQDN）。您也可以添加非限定名称以添加非限定名称  
        192.168.221.10 hadoop1.teradata.com hadoop1
        192.168.221.11 hadoop2.teradata.com hadoop2
        192.168.221.12 hadoop3.teradata.com hadoop3 
3. 编辑host的hostname`/etc/sysconfig/network`用FQDN：  
        HOSTNAME=hadoop1.teradata.com
4. 验证host是不是唯一的标识对于network    
- `uname -a`(验证输出是不是和hostname相同)
- `ifconfig`(验证IP地址)  
- `host -v -t A $(hostname)` (验证输出是不是符合hostname命令，IP地址是不是和ifconfig命令中的eth0,bond0一样)  

## 3、权限设置  

我们使用root用户的最高权限，但是不同主机之间不要配置无密码登录，步骤如下：  
只配置主节点到子节点的无密登录就行  
先删除所有密钥 `rm -rf ~/.ssh/*`  

        # ssh-keygen -t rsa
        # ssh-copy-id master
        # ssh-copy-id slave1
        # ssh-copy-id slave2

        # ssh localhost  
        
## 4、JDK安装
    安装在/usr/java目录下
## 5、其他事项
- 关闭防火墙
      systemctl stop firewalld
      systemctl disable firewalld
- SELINUX关闭  

        setenforce 0
        sed -i "s/SELINUX=enforcing/SELINUX=disabled/" /etc/selinux/config
        iptables --flush
        reboot  #重启生效
        
- 设置文件打开数量及最大进程数
        cp /etc/security/limits.conf /etc/security/limits.conf.bak
        echo "* soft nproc 32000" >>/etc/security/limits.conf
        echo "* hard nproc 32000" >>/etc/security/limits.conf
        echo "* soft nofile 65535" >>/etc/security/limits.conf
        echo "* hard nofile 65535" >>/etc/security/limits.conf
- 同步时间
安装ntp服务
        yum -y install ntp
启动ntp服务，并设置开机自启 
        systemctl start ntpd
        systemctl enable ntpd  

## 6、配置Cloudera Manager 管理库  
1. 在主节点中配置仓库，下载`Download the cloudera-manager.repo`文件   
       
        wget https://archive.cloudera.com/cm5/redhat/7/x86_64/cm/cloudera-manager.repo -P /etc/yum.repos.d/
2. 导入存储库签名GPG密钥：
        rpm --import https://archive.cloudera.com/cdh5/redhat/7/x86_64/cdh/RPM-GPG-KEY-cloudera

## 7、安装Cloudera Manager服务  
1. 手动安装：
        sudo yum --nogpgcheck localinstall cloudera-manager-daemons  -  * .rpm sudo yum --nogpgcheck localinstall cloudera-manager-server  -  * .rpm
2. 网络安装，前提配置了yum cloudera repo
        sudo yum install cloudera-manager-daemons cloudera-manager-server
        
## 8、安装和配置数据库
我们这次使用PostgreSQL试试，抛弃Mysql数据库  

1. 安装PostgreSQL数据库：  
        sudo yum install postgresql-server
2. 安装python-pip包（hue依赖她）:
        yum -y install epel-release
        sudo yum install python-pip
3. 安装psycopg2使用pip:
        sudo pip install psycopg2
4. 链接psycopg2目录为Hue Python环境
        sudo ln -s /usr/lib64/python2.7/site-packages/psycopg2 /opt/cloudera/parcels/CDH/lib/hue/build/env/lib/python2.7/site-packages/psycopg2  
配置和初始化PostgreSQL数据库
5. 确保LC_ALL被设定为en_US.UTF-8并按如下方式初始化数据库：
        echo'LC_ALL =“en_US.UTF-8”'>> /etc/locale.conf 
        sudo su -l postgres -c“postgresql-setup initdb”
6. 开启MD5验证，编辑pg_hba.conf文件，通常在/var/lib/pgsql/data or /etc/postgresql/<version>/main目录下，添加如下一行（在`host all all 127.0.0.1/32 ident`之前）
        host all all 127.0.0.1/32 md5
7. 因群集大小和资源而异，更新/var/lib/pgsql/data/postgresql.conf 或者 /var/lib/postgresql/data/postgresql.conf文件
> shared_buffers - 256MB  
> wal_buffers - 8MB  
> checkpoint_segments - 16  
> checkpoint_completion_target - 0.9  
8. 配置PostgreSQL 数据库开机启动  
        sudo systemctl enable postgresql
9. 重启数据库  
        sudo systemctl restart postgresql
## 9、 创建数据库为Cloudera software